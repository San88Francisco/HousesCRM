name: CI/CD Pipeline

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, closed]

jobs:
  # Сповіщення про створення/оновлення PR
  notify-on-pr:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Notify about pull request
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="📥 Новий/оновлений PR у *${{ github.event.pull_request.base.ref }}*: ${{ github.event.pull_request.title }}\n👤 Автор: ${{ github.actor }}\n🔗 https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"

  # >>> ЛИШЕ ДЛЯ main: тести + деплой після merge
  test-and-deploy-main:
    if: >
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run docker compose (tests/healthchecks)
        run: |
          docker compose -f docker-compose.yml up -d
          sleep 10
          docker compose ps

      - name: Notify failure (tests)
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="❌ Тести не пройшли після merge у *main*\n🔗 https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Deploy to Koyeb
        if: success()
        run: |
          curl -X POST https://app.koyeb.com/hook/deploy/${{ secrets.KOYEB_DEPLOY_HOOK }}

      - name: Notify success (deploy)
        if: success()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="✅ *Деплой успішний* після merge у *main*\n🔗 https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Notify failure (deploy)
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="🚨 *Деплой провалено* після merge у *main*\n🔗 https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  # >>> ЛИШЕ ДЛЯ develop: лише повідомлення після merge
  notify-merged-develop:
    if: >
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'develop'
    runs-on: ubuntu-latest
    steps:
      - name: Notify success (merge develop)
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="🟢 Успішний merge у *develop*\n🔗 https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"
