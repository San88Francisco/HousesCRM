deploy:
  if: github.ref == 'refs/heads/develop'
  needs: test
  runs-on: ubuntu-latest

  steps:
    - name: Checkout code
      uses: actions/checkout@v3

    
    - name: Validate required secrets
      run: |
        missing=0
        for v in KOYEB_API_KEY KOYEB_SERVICE_ID TELEGRAM_BOT_TOKEN TELEGRAM_CHAT_ID; do
          if [ -z "${{ secrets[format('{0}', v)] }}" ]; then
            echo "::error::Missing secret: $v"
            missing=1
          fi
        done
        [ $missing -eq 0 ] || exit 1

    
    - name: Trigger deploy on Koyeb (via API)
      env:
        KOYEB_API_KEY: ${{ secrets.KOYEB_API_KEY }}
        KOYEB_SERVICE_ID: ${{ secrets.KOYEB_SERVICE_ID }}
      run: |
        curl -fsS -X POST "https://app.koyeb.com/v1/services/${KOYEB_SERVICE_ID}/deployments" \
          -H "Authorization: Bearer ${KOYEB_API_KEY}" \
          -H "Content-Type: application/json" \
          -d '{}'

    - name: Install jq
      run: |
        sudo apt-get update -y
        sudo apt-get install -y jq

    - name: Wait for Koyeb deployment to be healthy
      env:
        KOYEB_API_KEY: ${{ secrets.KOYEB_API_KEY }}
        KOYEB_SERVICE_ID: ${{ secrets.KOYEB_SERVICE_ID }}
        TIMEOUT: "600"   
        SLEEP: "5"       
      run: |
        set -euo pipefail
        echo "‚è≥ –û—á—ñ–∫—É—î–º–æ –Ω–∞ –¥–µ–ø–ª–æ–π —Å–µ—Ä–≤—ñ—Å—É ${KOYEB_SERVICE_ID}..."
        end=$((SECONDS + TIMEOUT))
        while [ $SECONDS -lt $end ]; do
          RESP=$(curl -fsS -H "Authorization: Bearer ${KOYEB_API_KEY}" \
            "https://app.koyeb.com/v1/deployments?service_id=${KOYEB_SERVICE_ID}&limit=1")
          STATUS=$(echo "$RESP" | jq -r '.deployments[0].status // .deployments[0].state // "UNKNOWN"' | tr '[:lower:]' '[:upper:]')
          DEPLOY_ID=$(echo "$RESP" | jq -r '.deployments[0].id // ""')
          echo "‚Ä¢ Deployment ${DEPLOY_ID:-N/A} —Å—Ç–∞—Ç—É—Å: ${STATUS}"
          case "$STATUS" in
            HEALTHY) exit 0 ;;
            ERROR|UNHEALTHY|STOPPED) exit 1 ;;
            *) sleep "$SLEEP" ;;
          esac
        done
        echo "‚è∞ –¢–∞–π–º–∞—É—Ç –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –¥–µ–ø–ª–æ—é."
        exit 1

    - name: Notify success (deploy)
      if: success()
      run: |
        curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d parse_mode=Markdown \
          -d text="‚úÖ *–î–µ–ø–ª–æ–π —É—Å–ø—ñ—à–Ω–∏–π* —É *${{ github.ref_name }}*
          üîó https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

    - name: Notify failure (deploy)
      if: failure()
      run: |
        curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d parse_mode=Markdown \
          -d text="üö® *–î–µ–ø–ª–æ–π –ø—Ä–æ–≤–∞–ª–µ–Ω–æ* —É *${{ github.ref_name }}*
          üîó https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
