name: CI/CD Pipeline

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, closed]

jobs:
  # Ğ¡Ğ¿Ğ¾Ğ²Ñ–Ñ‰ĞµĞ½Ğ½Ñ Ğ¿Ñ€Ğ¾ ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ/Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ PR
  notify-on-pr:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Notify about pull request
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="ğŸ“¥ ĞĞ¾Ğ²Ğ¸Ğ¹/Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹ PR Ñƒ *${{ github.event.pull_request.base.ref }}*: ${{ github.event.pull_request.title }}\nğŸ‘¤ ĞĞ²Ñ‚Ğ¾Ñ€: ${{ github.actor }}\nğŸ”— https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"

  # >>> Ğ›Ğ˜Ğ¨Ğ• Ğ”Ğ›Ğ¯ main: Ñ‚ĞµÑÑ‚Ğ¸ + Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ¿Ñ–ÑĞ»Ñ merge
  test-and-deploy-main:
    if: >
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run docker compose (tests/healthchecks)
        run: |
          docker compose -f docker-compose.yml up -d
          sleep 10
          docker compose ps

      - name: Notify failure (tests)
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="âŒ Ğ¢ĞµÑÑ‚Ğ¸ Ğ½Ğµ Ğ¿Ñ€Ğ¾Ğ¹ÑˆĞ»Ğ¸ Ğ¿Ñ–ÑĞ»Ñ merge Ñƒ *main*\nğŸ”— https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Deploy to Koyeb
        if: success()
        run: |
          curl -X POST https://app.koyeb.com/hook/deploy/${{ secrets.KOYEB_DEPLOY_HOOK }}

      - name: Notify success (deploy)
        if: success()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="âœ… *Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ ÑƒÑĞ¿Ñ–ÑˆĞ½Ğ¸Ğ¹* Ğ¿Ñ–ÑĞ»Ñ merge Ñƒ *main*\nğŸ”— https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Notify failure (deploy)
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="ğŸš¨ *Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ»ĞµĞ½Ğ¾* Ğ¿Ñ–ÑĞ»Ñ merge Ñƒ *main*\nğŸ”— https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  # >>> Ğ›Ğ˜Ğ¨Ğ• Ğ”Ğ›Ğ¯ develop: Ğ»Ğ¸ÑˆĞµ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ Ğ¿Ñ–ÑĞ»Ñ merge
  notify-merged-develop:
    if: >
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'develop'
    runs-on: ubuntu-latest
    steps:
      - name: Notify success (merge develop)
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="ğŸŸ¢ Ğ£ÑĞ¿Ñ–ÑˆĞ½Ğ¸Ğ¹ merge Ñƒ *develop*\nğŸ”— https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"
