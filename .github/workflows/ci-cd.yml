name: CI/CD Pipeline

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  notify-on-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Notify about pull request
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="üì• –ù–æ–≤–∏–π Pull Request: ${{ github.event.pull_request.title }} üë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }} üîó https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Run docker compose (tests/healthchecks)
        run: |
          docker compose -f docker-compose.yml up -d
          sleep 10
          docker compose ps
      - name: Notify failure (tests)
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="‚ùå –¢–µ—Å—Ç–∏ –Ω–µ –ø—Ä–æ–π—à–ª–∏ —É *${{ github.ref_name }}* üîó https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  deploy:
    if: github.ref == 'refs/heads/develop'
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # ‚¨áÔ∏è –ù–û–í–ï: –¥–µ–ø–ª–æ–π –±–µ–∑ –≤–µ–±—Ö—É–∫–∞ ‚Äî —á–µ—Ä–µ–∑ Koyeb CLI + –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è HEALTHY
      - name: Install Koyeb CLI + jq
        run: |
          curl -fsSL https://get.koyeb.com | sh
          sudo mv koyeb /usr/local/bin/
          sudo apt-get update && sudo apt-get install -y jq

      - name: Redeploy service on Koyeb and wait for HEALTHY
        env:
          KOYEB_TOKEN: ${{ secrets.KOYEB_API_TOKEN }}   # ‚Üê —Ç–≤—ñ–π API —Ç–æ–∫–µ–Ω –∑ Koyeb
          KOYEB_APP: troubled-paula
          KOYEB_SERVICE_NAME: housescrm
          TIMEOUT_SECONDS: "900"   # 15 —Ö–≤
          SLEEP_SECONDS: "10"
        shell: bash
        run: |
          set -euo pipefail
          export KOYEB_TOKEN

          # –ó–Ω–∞–π—Ç–∏ ID —Å–µ—Ä–≤—ñ—Å—É –∑–∞ —ñ–º'—è–º —Ç–∞ app
          SERVICE_ID="$(koyeb services list --app "$KOYEB_APP" -o json | jq -r --arg n "$KOYEB_SERVICE_NAME" '.services[] | select(.name==$n) .id')"
          if [[ -z "${SERVICE_ID}" || "${SERVICE_ID}" == "null" ]]; then
            echo "–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ —Å–µ—Ä–≤—ñ—Å $KOYEB_APP/$KOYEB_SERVICE_NAME"
            exit 1
          fi
          echo "Service ID: ${SERVICE_ID}"

          # –¢—Ä–∏–≥–µ—Ä–∏–º–æ redeploy
          echo "‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫–∞—é redeploy‚Ä¶"
          koyeb services redeploy "${SERVICE_ID}"

          # –ß–µ–∫–∞—î–º–æ –ø–æ–∫–∏ –æ—Å—Ç–∞–Ω–Ω—ñ–π –¥–µ–ø–ª–æ–π —Å—Ç–∞–Ω–µ HEALTHY
          echo "‚è≥ –û—á—ñ–∫—É—î–º–æ —Å—Ç–∞—Ç—É—Å HEALTHY‚Ä¶"
          start_ts=$(date +%s)
          while true; do
            STATUS="$(koyeb deployments list --service "${SERVICE_ID}" -o json | jq -r '.deployments[0].status')"
            echo "–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞—Ç—É—Å: ${STATUS}"

            if [[ "${STATUS}" == "HEALTHY" ]]; then
              echo "‚úÖ Deployment is healthy."
              break
            fi

            if [[ "${STATUS}" == "UNHEALTHY" || "${STATUS}" == "FAILED" ]]; then
              echo "‚ùå Deployment status: ${STATUS}"
              exit 1
            fi

            now_ts=$(date +%s)
            if (( now_ts - start_ts > TIMEOUT_SECONDS )); then
              echo "‚è±Ô∏è –¢–∞–π–º–∞—É—Ç –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –¥–µ–ø–ª–æ—é."
              exit 1
            fi

            sleep "${SLEEP_SECONDS}"
          done

      - name: Notify success (deploy)
        if: success()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="‚úÖ *–î–µ–ø–ª–æ–π —É—Å–ø—ñ—à–Ω–∏–π* —É *${{ github.ref_name }}* üîó https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Notify failure (deploy)
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="üö® *–î–µ–ø–ª–æ–π –ø—Ä–æ–≤–∞–ª–µ–Ω–æ* —É *${{ github.ref_name }}* üîó https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
