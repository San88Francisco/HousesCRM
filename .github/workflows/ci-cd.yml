deploy:
  if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
  needs: test
  runs-on: ubuntu-latest

  steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Trigger deploy on Koyeb and wait for completion
      env:
        KOYEB_DEPLOY_HOOK: ${{ secrets.KOYEB_DEPLOY_HOOK }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "Triggering deploy..."
        # –ó–∞–ø—É—Å–∫–∞—î–º–æ –¥–µ–ø–ª–æ–π —ñ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
        DEPLOY_RESPONSE=$(curl -s -X POST "https://app.koyeb.com/hook/deploy/$KOYEB_DEPLOY_HOOK")

        # –¢—É—Ç –ø–æ—Ç—Ä—ñ–±–Ω–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ deploy_id –∞–±–æ —ñ–Ω—à–∏–π —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä, —è–∫—â–æ API –π–æ–≥–æ –ø–æ–≤–µ—Ä—Ç–∞—î
        # –ü—Ä–∏–ø—É—Å—Ç–∏–º–æ, —É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ —î –ø–æ–ª–µ "deploy_id"
        DEPLOY_ID=$(echo "$DEPLOY_RESPONSE" | jq -r '.deploy_id')

        if [ "$DEPLOY_ID" = "null" ] || [ -z "$DEPLOY_ID" ]; then
          echo "Failed to get deploy ID from Koyeb response"
          exit 1
        fi

        echo "Deploy ID: $DEPLOY_ID"

        # –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å—É –¥–µ–ø–ª–æ—é
        check_status() {
          STATUS_RESPONSE=$(curl -s "https://app.koyeb.com/api/v1/deployments/$DEPLOY_ID")
          STATUS=$(echo "$STATUS_RESPONSE" | jq -r '.status')
          echo "$STATUS"
        }

        # –ß–µ–∫–∞—î–º–æ, –¥–æ–∫–∏ –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è (–º–∞–∫—Å–∏–º—É–º 10 —Ö–≤–∏–ª–∏–Ω)
        TIMEOUT=600
        INTERVAL=15
        ELAPSED=0

        while true; do
          STATUS=$(check_status)
          echo "Deploy status: $STATUS"

          if [ "$STATUS" = "succeeded" ]; then
            echo "Deploy succeeded"
            exit 0
          elif [ "$STATUS" = "failed" ]; then
            echo "Deploy failed"
            exit 1
          fi

          if [ "$ELAPSED" -ge "$TIMEOUT" ]; then
            echo "Deploy timed out"
            exit 1
          fi

          sleep $INTERVAL
          ELAPSED=$((ELAPSED + INTERVAL))
        done

    - name: Notify success (deploy)
      if: success()
      run: |
        curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="‚úÖ *–î–µ–ø–ª–æ–π —É—Å–ø—ñ—à–Ω–∏–π* —É *${{ github.ref_name }}*\nüîó https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

    - name: Notify failure (deploy)
      if: failure()
      run: |
        curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="üö® *–î–µ–ø–ª–æ–π –ø—Ä–æ–≤–∞–ª–µ–Ω–æ* —É *${{ github.ref_name }}*\nüîó https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
